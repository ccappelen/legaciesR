<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Data management for the LEGACIES data project • legaciesr</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Data management for the LEGACIES data project">
<meta name="description" content="Contains functions for aggregating overlapping polygons.">
<meta property="og:description" content="Contains functions for aggregating overlapping polygons.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">legaciesr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ccappelen/legaciesR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="legaciesr">legaciesr<a class="anchor" aria-label="anchor" href="#legaciesr"></a>
</h1></div>
<!-- badges: start -->
<!-- [![Codecov test coverage](https://codecov.io/gh/ccappelen/legaciesR/graph/badge.svg)](https://app.codecov.io/gh/ccappelen/legaciesR) -->
<!-- [![R-CMD-check](https://github.com/ccappelen/legaciesR/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/ccappelen/legaciesR/actions/workflows/R-CMD-check.yaml) -->
<!-- badges: end -->
<p>The <code>legaciesr</code> package provides a set of functions used to aggregate and summarize the mapping and ID data collected in the <a href="https://www.legacies-project.com" class="external-link">LEGACIES</a> project. It allows users to, i.a., (1) create contour polygons capturing the territorial extent of historical states at different probability thresholds, (2) create a grid with various summary measures of historical state presence, and (3) add a range of commonly used covariates to the polygon and grid data.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of legaciesr from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"ccappelen/legaciesR"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.legacies-project.com" class="external-link">legaciesr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="package-overview-and-workflow">Package overview and workflow<a class="anchor" aria-label="anchor" href="#package-overview-and-workflow"></a>
</h2>
<p>The legaciesr package is composed of a number of functions designed to process and match the raw mapping and state data collected in the LEGACIES project. While they can, in most cases, be run independently of each other, they are mostly meant to be used in the workflow described in the remainder of this README. In short, it consists of <!-- (1) fixing invalid geometries in the map data, (2) preprocess the map data and match with information in the ISD state data, (3) detect potential errors in the data set, (4) generate contour polygons from the raw map data, (5) generate a grid cell data set with various summary measures of historical statehood, and (6) match the grid cell data with numerous other data sources commonly used in empirical applications.  --></p>
<ol style="list-style-type: decimal">
<li>Detecting and fixing invalid geometries in the map data.</li>
<li>Preprocessing the map data and match with information in the ISD state data.</li>
<li>Detecting potential errors in the data set.</li>
<li>Generating contour polygons from the raw map data. (Optional)</li>
<li>Generating a grid cell data set with various summary measures of historical statehood.</li>
<li>Matching the grid cell data with numerous other data sources commonly used in empirical applications.</li>
</ol>
<p>Each function (corresponding to each of the six steps) is further documented in their respective help documentation. This guide will outline the basic features of the functions and their intended usage.</p>
</div>
<div class="section level2">
<h2 id="support-for-parallel-processing">Support for parallel processing:<a class="anchor" aria-label="anchor" href="#support-for-parallel-processing"></a>
</h2>
<p>Some functions enable parallel processing to speed up intensive tasks. Parallel processing is is implemented using the [future::future] framework. There are two ways of running jobs in parallel: <code>multicore</code> which uses ‘forking’ to run multiple jobs in parallel with shared memory and <code>multisession</code> which launches a set of background R sessions. ‘Forking’ can be faster than multisession because of the larger overhead associated with copying the active environment to each background R session (whereas forking processes shares memory). However, ‘forking’ is not supported on Windows platforms and is considered unstable when running from within RStudio (on both Windows and Unix systems such as MacOS). The function will automatically determine whether <code>multicore</code> is supported by the platform and choose the appropriate plan.</p>
<p>The greater overhead associated with <code>multisession</code> is primarily during the first parallel run in a given R session (since the background R sessions stays available for additional parallel jobs). It is possible to define a [future::plan(“multisession”)] in the global environment, which will minimize overhead in subsequent parallel jobs (apart from the first). The function will automatically detect if a <code>multisession</code> plan has been set globally and, thus, will not close background sessions after running.</p>
<p>It is therefore recommended to start the script by setting a [future::plan]:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## The above code sets up parallel processing on all available cores. </span></span>
<span><span class="co">## This can be changed with the 'workers' option. </span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="reading-the-data">Reading the data<a class="anchor" aria-label="anchor" href="#reading-the-data"></a>
</h2>
<p>The raw map and ISD data is not currently included in the package and therefore has to be loaded from the user’s own directory:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shp_folder</span> <span class="op">&lt;-</span> <span class="st">"path to map data folder"</span></span>
<span><span class="va">shp_name</span> <span class="op">&lt;-</span> <span class="st">"name of shapefile"</span></span>
<span><span class="va">isd_path</span> <span class="op">&lt;-</span> <span class="st">"file path to isd data"</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">shp_path</span>, <span class="va">shp_name</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">shp_folder</span>, <span class="va">shp_name</span><span class="op">)</span></span>
<span></span>
<span><span class="va">isd</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu">read_xlsx</span><span class="op">(</span><span class="va">isd_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">isd_path</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="invalid-geometries">Invalid geometries<a class="anchor" aria-label="anchor" href="#invalid-geometries"></a>
</h2>
<p>Some maps in the raw data may be “invalid” which will result in errors in many spatial data analyses. This can happen for all kinds of reasons; typically it is the result of crossing boundaries. <code><a href="reference/fix_invalid.html">fix_invalid()</a></code> attempts to detect and fix these invalid geometries. It is a wrapper around the <code><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">sf::st_make_valid()</a></code> function that attempts to reiteratively lower the allowed precision to rebuild valid geometries. The function will return the same data set with fixed geometries (if it was able to fix them). The returned data set will include three columns describing the status of the geometry, e.g., whether it was invalid and whether it was successfully fixed. It will also (by default) print a summary of how many geometries were invalid, how many were fixed, and how many were unsuccessful.</p>
<p>Because invalid geometries can happen for many reasons that may point to other data errors as well, it is recommended to check for valid geometries and run the <code><a href="reference/fix_invalid.html">legaciesr::fix_invalid()</a></code> to identify potential issues.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fix_invalid.html">fix_invalid</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span></span>
<span><span class="co">#&gt; 447 (3.3 %) geometries were successfully rebuilt.</span></span>
<span><span class="co">#&gt; 0 (0 %) geometries failed to rebuild as valid.</span></span>
<span></span>
<span><span class="co">## CROP SHP FOR NOW</span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="va">shp</span><span class="op">[</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_within</a></span><span class="op">(</span><span class="va">shp</span>,</span>
<span>                     <span class="fu">rnaturalearthdata</span><span class="fu">::</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearthdata/reference/countries.html" class="external-link">countries50</a></span> <span class="op">|&gt;</span></span>
<span>                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">subregion</span> <span class="op">==</span> <span class="st">"Western Africa"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                       <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span>, sparse <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/prepare_shapes.html">prepare_shapes</a></span><span class="op">(</span>shp <span class="op">=</span> <span class="va">shp</span>, state_data <span class="op">=</span> <span class="va">isd</span>,</span>
<span>                      id_var <span class="op">=</span> <span class="va">COWID</span>, period_var <span class="op">=</span> <span class="va">year</span>,</span>
<span>                      range_min <span class="op">=</span> <span class="va">lyear</span>, range_max <span class="op">=</span> <span class="va">hyear</span>,</span>
<span>                      crop_to_land <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">## 'get_contours' currently not working when cropped to land</span></span>
<span>                      exclude_core <span class="op">=</span> <span class="cn">FALSE</span> <span class="co">## Currently errors in 'core' and 'Core.Great' coding.</span></span>
<span>                      <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="detecing-errors">Detecing errors<a class="anchor" aria-label="anchor" href="#detecing-errors"></a>
</h2>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">errors</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/detect_errors.html">detect_errors</a></span><span class="op">(</span>shp <span class="op">=</span> <span class="va">shp</span>, capital_data <span class="op">=</span> <span class="va">isd</span>,</span>
<span>                        id_var <span class="op">=</span> <span class="va">COWID</span>, period_var <span class="op">=</span> <span class="va">year</span>,</span>
<span>                        progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; POTENTIAL ERRORS:</span></span>
<span><span class="co">#&gt; • 15 states with potentially duplicate COWIDs.</span></span>
<span><span class="co">#&gt; • 0 shapes with empty geometries.</span></span>
<span><span class="co">#&gt; • 1 shapes with missing IDs.</span></span>
<span><span class="co">#&gt; • 26 COWIDs with only a single map.</span></span>
<span><span class="co">#&gt; • 465 maps with years missing or outside 1750-1920.</span></span>
<span><span class="co">#&gt; • 310 maps that do not overlap with other shapes with the same ID.</span></span>
<span><span class="co">#&gt; • 482 maps where the capital falls outside the polygon.</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/ccappelen/legaciesR/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/ccappelen/legaciesR/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing legaciesr</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Christoffer Cappelen <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christoffer Cappelen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
